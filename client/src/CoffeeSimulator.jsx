import { useState, useRef, useEffect } from 'react';
import { motion } from 'framer-motion';
import Navbar from "./navbar";
import { updateUserAchievement } from "./firebase/firebaseAchievements";
import { useNavigate } from "react-router-dom";
import { getAuth, onAuthStateChanged } from "firebase/auth";

const CoffeeSimulator = ({ userId: propUserId, selectedMenu }) => {
  const [currentStep, setCurrentStep] = useState(0);
  const [message, setMessage] = useState('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡πÅ‡∏ü!');
  const [completedSteps, setCompletedSteps] = useState([]);
  const [workspaceItems, setWorkspaceItems] = useState([]);
  const [isGround,setIsGround] = useState(false);
  const [isGrinding, setIsGrinding] = useState(false);
  const [isPouring, setIsPouring] = useState(false);
  const [pointerPosition, setPointerPosition] = useState(0);
  const [direction, setDirection] = useState(1);
  const [qteActive, setQteActive] = useState(false); // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î QTE
  const [qteCount, setQteCount] = useState(0); // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÉ‡∏ô QTE
  const [isReadyToServe, setIsReadyToServe] = useState(false); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
  const [dripImage, setDripImage] = useState('/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png'); // ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  const [isGifPlaying, setIsGifPlaying] = useState(false); // ‡∏•‡πá‡∏≠‡∏Å QTE ‡∏Ç‡∏ì‡∏∞ gif ‡πÄ‡∏•‡πà‡∏ô
  const [menuId, setMenuId] = useState(selectedMenu || "espresso");
  const [userId, setUserId] = useState(propUserId || null);

  const navigate = useNavigate();

  const [steps, setSteps] = useState([
    {
      id: 'grind',
      name: '‡∏ö‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü',
      description: '‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡πâ‡∏≤‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏î',
      equipment: [
        { id: 'coffee-beans', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü', draggable: true,image:'/simulator/‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü.png' },
        { id: 'grinder', name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î', draggable: true,image:'/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î).png' },
        { id: 'ground-coffee', name: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î', draggable: true, state: 'hidden',image:'/simulator/‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png' }, // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      ],
    },
    {
      id: 'prepare-drip',
      name: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ',
      description: '‡∏•‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏•‡∏¥‡πà‡∏ô',
      equipment: [
        { id: 'drip-stand', name: '‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå', draggable: true,image:'/simulator/‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå.png' },
        { id: 'paper-filter', name: '‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á', draggable: true,image:'/simulator/‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á.png' },
        { id: 'drip-pot', name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ', draggable: true,image:'/simulator/‡πÇ‡∏ñ‡∏£‡∏≠‡∏á.png' },
        { id: 'kettle', name: '‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ', draggable: true,image:'/simulator/‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ.png' },
      ],
    },
    {
      id: 'brew',
      name: '‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü',
      description: '‡∏•‡∏≤‡∏Å‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü',
      equipment: [
        { id: 'kettle', name: '‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ', draggable: true,image:'/simulator/‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ.jpg' },
      ],
    },    
    {
      id: 'finish',
      name: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
      description: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
      equipment: [] // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
    }    
  ]);

  useEffect(() => {
    if (!propUserId) { // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ userId ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firebase
      const auth = getAuth();
      const unsubscribe = onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("‚úÖ ‡∏î‡∏∂‡∏á userId ‡∏à‡∏≤‡∏Å Firebase:", user.uid);
          setUserId(user.uid);
        } else {
          console.log("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
        }
      });

      return () => unsubscribe();
    }
  }, [propUserId]); // ‚úÖ ‡∏ñ‡πâ‡∏≤ props ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firebase

  useEffect(() => {
    const backgroundMusic = new Audio('/simulator/cafe-music.mp3');
    backgroundMusic.loop = true; // üîÑ ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏•‡∏á
    backgroundMusic.volume = 0.5; // üîä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    backgroundMusic.play().catch(error => console.log("Autoplay failed:", error)); // ‡∏à‡∏±‡∏ö error ‡∏ñ‡πâ‡∏≤ autoplay ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ
  
    return () => {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0; // üîπ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    };
  }, []);

  const startBackgroundMusic = () => {
    if (!window.backgroundMusic) {
      window.backgroundMusic = new Audio('/simulator/cafe-music.mp3');
      window.backgroundMusic.loop = true;
      window.backgroundMusic.volume = 0.5;
    }
    window.backgroundMusic.play();
  };  

  const [subtitle, setSubtitle] = useState('');

  const workspaceRef = useRef(null);

  useEffect(() => {
    let interval;
    let newMessage = "";
  
    if (currentStep === 2 && qteActive) { // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô QTE (‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü)
      newMessage = "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≤‡πÅ‡∏ü‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
  
      interval = setInterval(() => {
        setPointerPosition((prev) => {
          let newPosition = prev + direction * 1; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Pointer ‡∏ï‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á
  
          if (newPosition <= 0) {
            setDirection(1); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢
          } else if (newPosition >= 100) {
            setDirection(-1); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤
          }
  
          return Math.max(0, Math.min(100, newPosition)); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-100
        });
      }, 10); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á pointer ‡∏ó‡∏∏‡∏Å 10ms
  
    } else {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
      switch (currentStep) {
        case 0:
          newMessage = "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏î‡∏Å‡∏≤‡πÅ‡∏ü ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏°‡∏∑‡∏≠‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ô‡∏≥‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏î‡∏Å‡∏≤‡πÅ‡∏ü";
          break;
        case 1:
          newMessage = "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á";
          break;
        case 2:
          newMessage = "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü‡∏Å‡∏±‡∏ô! ‡∏ô‡∏≥‡∏Å‡∏≤‡πÅ‡∏ü‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ö‡∏î‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏≥‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü";
          break;
        case 3:
          newMessage = "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏î‡πâ";
          break;
        default:
          newMessage = steps[currentStep]?.description || "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡πÅ‡∏ü!";
      }
    }
  
    setMessage(newMessage);
  
    return () => {
      if (interval) clearInterval(interval); // ‡∏•‡πâ‡∏≤‡∏á Interval ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
    };
  }, [currentStep, qteActive, direction, steps]);
  
  // ‚úÖ ‡πÉ‡∏ä‡πâ useEffect ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Subtitle Area
  useEffect(() => {
    // ‡πÉ‡∏ä‡πâ message ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Subtitle
    setSubtitle(message);
  }, [message]);  

  const handleDragEnd = (item, event, info) => {
    const workspaceRect = workspaceRef.current?.getBoundingClientRect();
    if (!workspaceRect) return;
  
    const isInWorkspace =
      info.point.x >= workspaceRect.left &&
      info.point.x <= workspaceRect.right &&
      info.point.y >= workspaceRect.top &&
      info.point.y <= workspaceRect.bottom;
  
    if (isInWorkspace) {
      setWorkspaceItems((current) => {
        let updatedItems = [...current];
  
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏î‡∏Å‡∏≤‡πÅ‡∏ü
        if (currentStep === 0) {
          // ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥
          if (current.some((i) => i.id === item.id)) {
            setMessage('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!');
            return current;
          }
  
          // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
          if (item.id === 'ground-coffee' && item.state === 'ready-to-use') {
            if (current.some((i) => i.id === 'ground-coffee')) {
              setMessage('‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!');
              return current;
            }

            updatedItems.push({
              id: 'ground-coffee',
              name: '‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î',
              state: 'in-workspace', // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            });

            setMessage('‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£!');

            // ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `handleNextStep` ‡πÉ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            return updatedItems;
          }                  
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
          if (item.id === 'grinder' && !current.some((i) => i.id === 'grinder')) {
            updatedItems.push({ ...item, state: 'default' });
            setMessage('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏≥‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î');
            return updatedItems;
          }
  
          if (item.id === 'coffee-beans' && current.some((i) => i.id === 'grinder')) {
            updatedItems = current.map((i) =>
              i.id === 'grinder'
                ? { ...i, name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü', state: 'ready-to-grind' }
                : i
            );
            setMessage('‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
            
            return updatedItems;
          }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î
          if (item.id === 'coffee-beans' && !current.some((i) => i.id === 'grinder')) {
            setMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü!');
            return current;
          }
          setMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü');
          return current;
        }
  
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ
        if (currentStep === 1) {
          // ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥
          if (current.some((i) => i.id === item.id)) {
            setMessage('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!');
            return current;
          }
        
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ
          if (item.id === 'drip-pot' && !current.some((i) => i.state === 'drip-pot')) {
            setMessage('‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå');
            return [...current, { ...item, state: 'drip-pot' }];
          }
        
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå
          if (item.id === 'drip-stand' && current.some((i) => i.state === 'drip-pot')) {
            setMessage('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏£‡∏¥‡∏õ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å');
            return current.map((i) =>
              i.state === 'drip-pot'
                ? { ...i, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå', state: 'drip-stand' }
                : i
            );
          }
        
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á
          if (item.id === 'paper-filter' && current.some((i) => i.state === 'drip-stand')) {
            setMessage('‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ ‡∏ô‡∏≥‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ‡∏°‡∏≤‡πÄ‡∏ó‡πÉ‡∏™‡πà‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
            return current.map((i) =>
              i.state === 'drip-stand'
                ? { ...i, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á', state: 'paper-filter' }
                : i
            );
          }
        
          // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á
          if (item.id === 'kettle' && current.some((i) => i.state === 'paper-filter')) {
            setMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á...');
            setIsPouring(true);

            const dripSound = new Audio('/simulator/drip-sound.mp3');
            dripSound.play();

            setTimeout(() => {
              setIsPouring(false);
              const updatedItems = current.map((i) =>
                i.state === 'paper-filter'
                  ? { ...i, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏ô‡πâ‡∏≥', state: 'ready-to-pour-out' }
                  : i
              );
              setWorkspaceItems(updatedItems);
              setMessage('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏ñ');
            }, 3000);
        
            return current;
          }
        
          setMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
          return current;
        }
  
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü
        if (currentStep === 2) {
          if (current.some((i) => i.id === item.id)) {
            setMessage('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!');
            return current;
          }
  
          if (item.id === 'ground-coffee' && current.some((i) => i.state === 'waiting-for-ground-coffee')) {
            const updatedItems = current.map((i) =>
              i.state === 'waiting-for-ground-coffee'
                ? { ...i, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü', state: 'waiting-for-kettle' }
                : i
            );
            setMessage('‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏≥‡∏Å‡∏≤‡∏î‡∏£‡∏¥‡∏õ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü');
            return updatedItems;
          }
  
          if (item.id === 'kettle' && current.some((i) => i.state === 'waiting-for-kettle')) {
            const updatedItems = current.map((i) =>
              i.state === 'waiting-for-kettle'
                ? { ...i, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü', state: 'ready-to-brew' }
                : i
            );
            setMessage('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≤‡πÅ‡∏ü‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');

                // ‡πÄ‡∏õ‡∏¥‡∏î QTE ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏£‡∏ö
            setQteActive(true); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô QTE
            return updatedItems;
          }
  
          setMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏Å‡πà‡∏≠‡∏ô');
          return current;
        }
  
        return current;
      });
    } else {
      setMessage('‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
    }
  };  

  const handlePourOut = () => {
    if (currentStep === 1 && // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ
      workspaceItems.some((item) => item.state === 'ready-to-pour-out') // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ
    ) {
      setMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ...');
  
      const pourSound = new Audio('/simulator/pour-sound.mp3');
      pourSound.play();

      setTimeout(() => {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3
        const updatedItems = workspaceItems.map((item) =>
          item.state === 'ready-to-pour-out'
            ? { ...item, name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á', state: 'ready-to-drip' }
            : item
        );
  
        setWorkspaceItems(updatedItems); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï workspaceItems
        setMessage('‡∏ô‡πâ‡∏≥‡∏ñ‡∏π‡∏Å‡πÄ‡∏ó‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏£‡∏¥‡∏õ');
        handleNextStep(); // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      }, 3000); // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    } else {
      setMessage('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å');
    }
  };

  const handleServe = () => {
    setMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡∏•‡∏á‡πÅ‡∏Å‡πâ‡∏ß...'); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü
    setTimeout(() => {
      // ‡∏•‡∏ö‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏à‡∏≤‡∏Å Workspace
      setWorkspaceItems((current) =>
        current.filter((item) => item.state !== 'ready-to-serve')
      );
      handleNextStep(); // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
      setMessage('‡∏Å‡∏≤‡πÅ‡∏ü‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü! ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢'); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏™‡∏£‡πá‡∏à
    }, 1000); // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  };

  const handleQTEClick = () => {
    const targetLeft = 40; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á target zone
    const targetRight = 60; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á target zone

    if (isGifPlaying) return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ gif ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Pointer ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (pointerPosition >= targetLeft && pointerPosition <= targetRight) {
        setQteCount((prevCount) => prevCount + 1); // ‡πÄ‡∏û‡∏¥‡πà‡∏° QTE count
    } else {
        setMessage('‡∏î‡∏£‡∏¥‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
    }
  };

  useEffect(() => {
    if (qteCount > 0 && qteCount < 3) {
        setMessage(`‡∏î‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${qteCount}/3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);

        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const timeout = setTimeout(() => {
            setMessage('');
        }, 3000);

        return () => clearTimeout(timeout); // ‡∏•‡πâ‡∏≤‡∏á timeout ‡πÄ‡∏°‡∏∑‡πà‡∏≠ component ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ render
    }

    if (qteCount === 3) {
        setQteActive(false); // ‡∏õ‡∏¥‡∏î QTE
        setIsReadyToServe(true); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
        setQteCount(0); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï QTE count

        setMessage('‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡πÉ‡∏™‡πà‡πÅ‡∏Å‡πâ‡∏ß');

        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const timeout = setTimeout(() => {
            setMessage('');
        }, 3000);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï workspace items ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
        setWorkspaceItems((current) =>
            current.map((item) =>
                item.id === 'ground-coffee' || item.id === 'kettle'
                    ? { ...item, state: 'ready-to-serve' }
                    : item
            )
        );

        handleNextStep(); // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

        return () => clearTimeout(timeout); // ‡∏•‡πâ‡∏≤‡∏á timeout ‡πÄ‡∏°‡∏∑‡πà‡∏≠ component ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ render
    }
  }, [qteCount]);
  
  const handleQTEProgress = () => {
    if (isGifPlaying) return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ gif ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà
  
    setIsGifPlaying(true); // ‡∏•‡πá‡∏≠‡∏Å QTE
    setDripImage('/simulator/‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü.png'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô gif

    const dripSound = new Audio('/simulator/drip-sound.mp3');
    dripSound.play();
  
    setTimeout(() => {
      setIsGifPlaying(false); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å QTE
      setDripImage('/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png'); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á
      setQteCount((prev) => prev + 1); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  
      if (qteCount + 1 === 3) {
        // ‡∏ñ‡πâ‡∏≤ QTE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        setDripImage('/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à
        setQteActive(false); // ‡∏õ‡∏¥‡∏î QTE
        setIsReadyToServe(true); // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        setMessage('QTE ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡πÉ‡∏™‡πà‡πÅ‡∏Å‡πâ‡∏ß');
      }
    }, 3000); // ‡πÄ‡∏ß‡∏•‡∏≤ gif 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  };  
  
  const handleGrind = () => {
    if (workspaceItems.some((item) => item.state === 'ready-to-grind')) {
      setIsGrinding(true);
      setMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü...3...2...1...');

      // ‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏î‡∏Å‡∏≤‡πÅ‡∏ü
      const grindSound = new Audio('/simulator/grind-sound.mp3');
      grindSound.play();

      setTimeout(() => {
        setIsGrinding(false);
  
        // ‡∏•‡∏ö "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        setWorkspaceItems((current) =>
          current.filter((item) => item.id !== 'grinder')
        );
  
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        setWorkspaceItems((current) => [
          ...current,
          {
            id: 'ground-coffee',
            name: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î',
            state: 'ready-to-use',
            image: '/simulator/‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png', // ‡πÉ‡∏ä‡πâ path ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          },
        ]);
  
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        setSteps((prevSteps) =>
          prevSteps.map((step) =>
            step.id === 'grind'
              ? {
                  ...step,
                  equipment: step.equipment.map((equip) =>
                    equip.id === 'ground-coffee'
                      ? { ...equip, state: 'ready-to-use' } // ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                      : equip
                  ),
                }
              : step
          )
        );
  
        setMessage('‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏ñ‡∏π‡∏Å‡∏ö‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        handleNextStep(); // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      }, 3000);
    } else {
      setMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏î');
    }
  };     

  const getImageByState = (item) => {
    if (item.id === 'grinder') {
      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ GIF
      if (isGrinding) return '/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î_.gif';
      
      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏î ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î
      if (item.state === 'ready-to-grind') return '/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î(‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î).png';
  
      // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡πÄ‡∏õ‡∏•‡πà‡∏≤
      return '/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î).png';
    }
    const imageMap = {
      "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î": "/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î).png",
      "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü": "/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏î(‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πá‡∏î).png",
      "‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î": "/simulator/‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ": "/simulator/‡πÇ‡∏ñ‡∏£‡∏≠‡∏á.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå": "/simulator/‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á": "/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏ô‡πâ‡∏≥": "/simulator/‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡πâ‡∏ß(‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î)": "/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ(‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡πâ‡∏ß).png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏á‡∏Å‡∏≤‡πÅ‡∏ü": "/simulator/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î.png",
      "‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü": "/simulator/‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü.png",
      "‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏ñ‡∏£‡∏≠‡∏á": "/simulator/‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏™‡∏£‡πá‡∏à.png",
    };
  
    // ‡∏´‡∏≤‡∏Å state ‡∏´‡∏£‡∏∑‡∏≠ name ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô map ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå
    return imageMap[item.name] || "/simulator/default.png";
  };  

  const handleNextStep = () => {
    setCompletedSteps((prev) => [...prev, steps[currentStep].id]); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
  
    if (currentStep === 0) {
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï workspaceItems ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
      setWorkspaceItems([]);
      setMessage('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏õ');
    } else if (currentStep === 1) {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°
      const newItem = {
        id: 'drip-pot-complete',
        name: '‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡πâ‡∏ß(‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏™‡πà‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î)',
        state: 'waiting-for-ground-coffee', // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î
      };
      setWorkspaceItems([newItem]);
      setMessage('‡πÇ‡∏ñ‡∏£‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏£‡∏¥‡∏õ');
    } else if (currentStep === steps.length - 1) {
      setMessage('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
    } else {
      setWorkspaceItems([]);
    }
  
    // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    setCurrentStep((prev) => prev + 1);
  };  
  
  const handleFinishMenu = async () => {
    if (!userId) {
      console.warn("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: userId ‡πÄ‡∏õ‡πá‡∏ô undefined ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      navigate("/coffee_menu"); // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ userId ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      return;
    }

    try {
      await updateUserAchievement(userId, menuId); // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      setMessage(`‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÄ‡∏°‡∏ô‡∏π ${menuId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!`);
    } catch (error) {
      console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
    } finally {
      navigate("/coffee_menu"); // ‚úÖ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ coffee_menu
    }
  };
  
  const handleRestart = () => {
    setCurrentStep(0);
    setMessage('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡πÅ‡∏ü!');
    setCompletedSteps([]);
    setWorkspaceItems([]);
    setIsGround(false);
    setIsGrinding(false);
    setIsPouring(false);
    setQteActive(false);
    setIsReadyToServe(false);
    setIsGifPlaying(false); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ gif
    setQteCount(0); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï QTE count
  
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡πÉ‡∏ô steps ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô hidden
    setSteps((prevSteps) =>
      prevSteps.map((step) =>
        step.id === 'grind'
          ? {
              ...step,
              equipment: step.equipment.map((equip) =>
                equip.id === 'ground-coffee'
                  ? { ...equip, state: 'hidden' } // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡πà‡∏≠‡∏ô
                  : equip
              ),
            }
          : step
      )
    );
  };  
 
const navbarHeight = 106; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Navbar (px)
const simulatorHeight = `calc(100vh - ${navbarHeight}px)`; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Simulator

  return (
    <div className="relative ">
      <Navbar />
      {/* üîπ Background Blur Layer */}
      <div className="absolute inset-0 bg-cover bg-center"
        style={{
          backgroundImage: "url('/simulator/bs-sim.jpg')", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô path ‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
          filter: "blur(8px)", // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏•‡∏≠
          zIndex: "-1", // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        }}
      ></div>
      {/* Layout */}
      <div className="grid grid-cols-12 gap-2 pt-2 px-4 sm:px-8 "  
      style={{
        height: simulatorHeight,
      }}>
        {/* Left Area - Equipment list */}
        <div className="col-span-12 sm:col-span-5 h-screen p-2"style={{ height: simulatorHeight }}>
          {/* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå */}
          <h3 className="text-center font-semibold text-2xl text-amber-900 mt-4">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ</h3>
          {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå */}
          <div className="mt-8 grid grid-cols-2  ">
            {/* ‡∏£‡∏ß‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô */}
            {Array.from(new Set(steps.flatMap(step => step.equipment
            .filter((item) => item.state !== "hidden") // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô
            .map(equipment => equipment.id)))).map((id) => {
              // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
              const equipment = steps
                .flatMap(step => step.equipment)
                .find(equipment => equipment.id === id);

              return (
                <motion.div
                  key={equipment.id}
                  className="flex items-center justify-center rounded-lg cursor-grab"
                  dragConstraints={{ left: 0, right: 0, top: 0, bottom: 0 }}
                  dragElastic={1}
                  initial={{ opacity: 0, scale: 0.8 }} // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏≤‡∏á
                  animate={{ opacity: 1, scale: 1 }} // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î
                  transition={{ duration: 0.3 }}
                  whileHover={{ scale: 1.1 }} // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover
                  whileTap={{ scale: 0.9 }} // ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                  onDragEnd={(event, info) => handleDragEnd(equipment, event, info)}
                  style={{
                    width: "100%", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                    height: "180px", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                  }}
                >
                  {/* ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */}
                  {equipment.image ? (
                    <motion.img
                    src={equipment.image} // ‡πÉ‡∏ä‡πâ path ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    alt={equipment.name}
                    className="object-contain cursor-grab" // ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor-grab ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    style={{
                      width: "100%", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                      height: "100%", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                    }}
                    drag // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    dragConstraints={{ left: 0, right: 0, top: 0, bottom: 0 }} // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å
                    dragElastic={1} // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
                    onDragEnd={(event, info) => handleDragEnd(equipment, event, info)} // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                    />
                  ) : (
                    <span>{equipment.name}</span> // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
                  )}
                </motion.div>
              );
            })}
          </div>
        </div>

        {/* Center Area - Action area */}
        <div ref={workspaceRef} className="col-span-12 sm:col-span-5 h-screen p-2 flex flex-col"style={{ height: simulatorHeight }}>
        {/* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ */}
        <h3 className="text-center font-semibold text-2xl text-amber-900 mt-4">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏°‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
        {/* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Workspace) */}
        <div className="mt-4 h-full flex flex-col items-center justify-start" style={{ height: "70%", paddingTop: "50px" }}>
          {currentStep === 3 ? (
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            <div className="flex flex-col items-center mt-4">
              {/* ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à */}
              <img
                src={`/simulator/‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡∏™‡πÇ‡∏ã.png`} // ‡πÉ‡∏ä‡πâ dynamic path ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏ô‡∏π
                alt={`‡πÄ‡∏°‡∏ô‡∏π ${menuId}`}
                className="w-80 h-80 object-cover"
              />

              {/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà */}
              <button
                onClick={handleRestart} // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ã‡∏¥‡∏°‡∏°‡∏π‡πÄ‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
                className="mt-4 text-white py-2 px-4 bg-blue-700 rounded shadow hover:bg-blue-800"
              >
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
              </button>

              {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */}
              {currentStep === steps.length - 1 && (
                <button
                  onClick={() => {
                    handleFinishMenu(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                  }}
                  className="mt-4 text-white py-2 px-4 bg-green-600 rounded shadow hover:bg-green-700"
                >
                  ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                </button>
              )}
            </div>
          ) : qteActive ? (
            // QTE ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ qteActive ‡πÄ‡∏õ‡πá‡∏ô true
            <div className="flex flex-col items-center">
            {/* ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ */}
              <img
                src={dripImage}
                alt="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏£‡∏¥‡∏õ"
                className="w-96 h-96 object-contain mb-4"
                style={{ marginTop: "25px" }} // ‡πÄ‡∏û‡∏¥‡πà‡∏° marginTop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
              />
              {/* QTE Components */}
              <div className="progress-container relative w-full max-w-lg mt-8">
                <div className="progress-bar w-full h-4 relative o verflow-hidden">
                  <div
                    className="target-zone bg-green-500 h-full absolute"
                    style={{ width: "20%", left: "40%" }}
                  ></div>
                  <div
                    className="pointer bg-red-500 h-full w-2 absolute"
                    style={{ left: `${pointerPosition}%` }}
                  ></div>
                </div>
              </div>
              <button
                onClick={handleQTEProgress}
                disabled={isGifPlaying} // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ì‡∏∞ gif ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà
                className={`mt-4 bg-blue-500 text-white py-2 px-4 rounded ${
                  isGifPlaying ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'
                }`}
              >
                ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏£‡∏¥‡∏õ
              </button>
            </div>
          ) : isReadyToServe ? (
              // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡πÉ‡∏™‡πà‡πÅ‡∏Å‡πâ‡∏ß
            <div className="flex flex-col items-center">
            <img
              src="/simulator/‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü‡πÄ‡∏™‡∏£‡πá‡∏à.png" // ‡πÉ‡∏™‡πà path ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              alt="‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡∏•‡∏á‡πÅ‡∏Å‡πâ‡∏ß"
              className="w-96 h-96 object-contain cursor-pointer" // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ cursor pointer
              onClick={handleServe} // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleServe ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
            />
          </div>
          ) : (
            // ‡πÅ‡∏™‡∏î‡∏á Workspace Items ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            workspaceItems.length > 0 &&
            workspaceItems.map((item) => (
              <motion.div
                key={item.id}
                className={`p-4 rounded mt-2 
                  ${item.state === "ready-to-grind" && !isGrinding ? "cursor-pointer" : ""}
                  ${item.id === "kettle" && isPouring ? "text-blue-500" : ""}
                  ${item.state === "ready-to-drip" ? "cursor-pointer bg-yellow-200" : ""}
                  ${item.state === "ready-to-pour-out" ? "cursor-pointer " : ""}
                  ${item.state === "ready-to-brew" ? "cursor-pointer bg-orange-300" : ""}
                  ${item.state === "ready-to-serve" ? "cursor-pointer bg-purple-300" : ""}
                `}
                onClick={
                  item.state === "ready-to-grind" && !isGrinding
                    ? handleGrind // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleGrind
                    : item.state === "ready-to-pour-out"
                    ? handlePourOut // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handlePourOut
                    : item.state === "waiting-for-ground-coffee"
                    ? () => setMessage("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏£‡∏¥‡∏õ")
                    : item.state === "ready-to-brew"
                    ? handleQTEClick // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å QTE
                    : item.state === "ready-to-serve"
                    ? handleServe // ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏Å‡∏≤‡πÅ‡∏ü‡∏•‡∏á‡πÅ‡∏Å‡πâ‡∏ß
                    : undefined
                }
                animate={item.id === 'grinder' && isGround ? { y: [-5, 5, 0] } : {}} // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á
                transition={{ duration: 0.3, repeat: isGrinding ? Infinity : 0, repeatType: "reverse" }} // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á
                style={{
                  width: "500px", // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                  height: "500px", // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                  display: "flex",
                  justifyContent: "center", // ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
                  alignItems: "center", // ‡∏à‡∏±‡∏î‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
                  opacity: item.state === "hidden" ? 0 : 1, // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏ö‡∏î‡∏Ö
                }}
              >
                {/* ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */}
                <img
                  src={getImageByState(item)} // ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏° state ‡∏´‡∏£‡∏∑‡∏≠ name
                  alt={item.name} // Alt text ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û
                  className="w-full h-full object-contain" // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
                />
              </motion.div>
            ))
          )}
        </div>
      </div>
      <div className="relative flex flex-col items-center">
        {/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤) */}
        <div className="w-full flex justify-end px-4">
          <button 
            onClick={startBackgroundMusic} 
            className="bg-gray-600 bg-opacity-80 hover:bg-gray-700 text-white mt-6 font-semibold px-5 py-2 rounded-xl shadow-lg flex items-center gap-2 transition-all duration-300">
            üéµ 
          </button>
        </div>

        {/* Right Area - Step List (‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) */}
        <div 
          className="col-span-12 sm:col-span-2 bg-orange-200 rounded shadow p-4 flex flex-col justify-center"
          style={{ 
            height: "420px", 
            width: "260px", 
            margin: "auto", 
            backgroundSize: "contain", 
            backgroundPosition: "center", 
            backgroundRepeat: "no-repeat",
            position: "absolute",
            top: "50%",
            transform: "translateY(-50%)" // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Step List ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á
          }}
        >
          {/* ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô */}
          <h3 className="text-center font-semibold text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ</h3>

          {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô */}
          <ul className="mt-4 list-none flex-grow">
            {steps.map((step, index) => (
              <li
                key={step.id} 
                className={`flex items-center mt-2 ${
                  index === currentStep ? 'font-bold text-yellow-950' : 'text-gray-800'
                }`} 
              >
                <input
                  type="checkbox" 
                  readOnly
                  checked={completedSteps.includes(step.id)} 
                  className="mr-2 accent-yellow-950" 
                />
                {step.name}
              </li>
            ))}
          </ul>
          {/* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô */}
          <div className="mt-4">
            <button
              className="bg-yellow-900 text-white w-full py-2 rounded shadow hover:bg-yellow-950 disabled:opacity-50"
              disabled={currentStep === 0} 
              onClick={() => {
                if (currentStep > 0) {
                  setCurrentStep((prev) => prev - 1);
                  setMessage(`‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ${steps[currentStep - 1]?.name}`);
                  setWorkspaceItems([]); 
                }
              }}
            >
              ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
            </button>
          </div>
        </div>
      </div>
        {/* Subtitle Area */}
        <div
          className="fixed bottom-8 left-1/2 transform -translate-x-1/2 text-center text-lg font-semibold text-white px-4 py-2 rounded"
          style={{
            backgroundColor: "rgba(0, 0, 0, 0.6)", // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            maxWidth: "90%", // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            zIndex: 50, // ‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
          }}
        >
          {subtitle}
        </div>
      </div>
    </div>
  );
};

export default CoffeeSimulator;
